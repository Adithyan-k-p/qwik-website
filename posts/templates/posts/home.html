{% extends 'base.html' %}

{% block title %}Home - Qwik{% endblock %}

{% block extra_css %}
<style>
    /* New Style for the Follow text button on posts */
    .post-follow-link {
        color: var(--accent-solid);
        font-weight: 600;
        font-size: 0.85rem;
        cursor: pointer;
        text-decoration: none;
        transition: color 0.2s;
    }
    .post-follow-link:hover { color: #556cd6; }

    /* Modal Content Box */
    .modal-content {
        background-color: var(--bg-card);
        width: 90%;
        max-width: 500px;
        border-radius: 12px;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
        position: relative;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    .modal-header {
        padding: 15px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-body {
        padding: 15px;
        overflow-y: auto;
        flex-grow: 1;
    }

    .modal-footer {
        padding: 15px;
        border-top: 1px solid var(--bg-hover);
        background: var(--bg-card);
    }

    .modal-close {
        cursor: pointer;
        font-size: 1.5rem;
        color: var(--text-secondary);
    }

    /* User list item in Like Modal */
    .user-row {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 15px;
    }

    .user-row img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
    }

    /* Separator Style */
    .post-separator {
        border: 0;
        border-top: 1px solid var(--bg-hover);
        margin: 10px 0;
    }

    /* Modal Input Styling */
    .modal-input-group {
        display: flex;
        gap: 10px;
    }
    .modal-input-group input {
        flex: 1;
        padding: 10px;
        border-radius: 20px;
        border: 1px solid var(--bg-hover);
        background: var(--bg-body);
        color: var(--text-main);
        outline: none;
    }
    .modal-input-group button {
        background: transparent;
        color: var(--accent-solid);
        border: none;
        font-weight: 600;
        cursor: pointer;
    }
</style>
{% endblock %}

{% block content %}
    <!-- CENTER CONTENT -->
    <main class="main-content">
        
        <!-- Loop through Django Posts -->
        {% for post in posts %}
            <article class="post">
                <div class="post-header">
                    <div class="user-block">
                        <!-- Profile Image Link -->
                        <a href="{% url 'accounts:profile' post.user.username %}">
                            {% if post.user.profile_image %}
                                <img src="{{ post.user.profile_image.url }}" class="p-avatar">
                            {% else %}
                                <img src="https://ui-avatars.com/api/?name={{ post.user.username }}&background=667eea&color=fff" class="p-avatar">
                            {% endif %}
                        </a>

                        <div class="p-info">
                            <div style="display: flex; align-items: center;">
                                <!-- Username Link -->
                                <h4><a href="{% url 'accounts:profile' post.user.username %}">{{ post.user.username }}</a></h4>
                                
                                {% if request.user != post.user and post.user.id not in following_ids %}
                                <span class="follow-area-{{ post.user.username }}">
                                    <span style="margin: 0 6px; color: var(--text-secondary); font-size: 0.8rem;">â€¢</span>
                                    <a href="{% url 'accounts:follow_user' post.user.username %}" 
                                    class="post-follow-link ajax-follow-btn" 
                                    data-username="{{ post.user.username }}">Follow</a>
                                </span>
                                {% endif %}
                            </div>

                            <div style="display: flex; align-items: center; gap: 5px;">
                                <span>{{ post.created_at|timesince }} ago</span>
                                {% if post.post_type == 'temporary' %}
                                    <span style="color: #e0245e; font-size: 0.75rem;" title="Temporary"><i class="fa-solid fa-hourglass-half"></i></span>
                                {% endif %}
                                {% if post.visibility == 'private' %}
                                    <span style="color: #65676B; font-size: 0.75rem;" title="Friends Only"><i class="fa-solid fa-lock"></i></span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- 3 Dots Menu Container -->
                    <div class="post-menu-container">
                        <button class="post-menu-btn" onclick="togglePostMenu(event, 'post-{{ post.id }}')">
                            <i class="fa-solid fa-ellipsis"></i>
                        </button>
                        
                        <div class="post-dropdown" id="menu-post-{{ post.id }}">
                            {% if request.user == post.user %}
                                <!-- Owner Options -->
                                <div class="post-dropdown-item text-danger" onclick="deletePost('{{ post.id }}')">
                                    <i class="fa-regular fa-trash-can"></i> Delete Post
                                </div>
                            {% else %}
                                <!-- Report Option -->
                                <div class="post-dropdown-item text-danger" onclick="openReportModal('post', '{{ post.id }}')">
                                    <i class="fa-regular fa-flag"></i> Report Post
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Image -->
                {% if post.image %}
                <div class="post-img-container">
                    <img src="{{ post.image.url }}" alt="Qwip">
                </div>
                {% endif %}

                <div class="post-footer">
                    <div class="action-bar">
                        <div class="left-actions">
                            <!-- LIKE COUNT -->
                            <button class="act-btn like-btn ajax-like-btn {% if post.id in liked_posts_ids %}liked{% endif %}" data-url="{% url 'posts:like_post' post.id %}" data-post-id="{{ post.id }}">
                                <i class="{% if post.id in liked_posts_ids %}fa-solid fa-heart{% else %}fa-regular fa-heart{% endif %}"style="{% if post.id in liked_posts_ids %}color: #e0245e;{% endif %}"></i>
                            </button>
                            <span class="open-likes-modal" data-post-id="{{ post.id }}" style="cursor:pointer; font-weight:600;">
                                <span class="like-count-{{ post.id }}">{{ post.like_count }}</span> likes
                            </span>

                            <!-- COMMENT ICON -->
                            <button class="act-btn open-comments-modal" data-post-id="{{ post.id }}">
                                <i class="fa-regular fa-comment"></i>
                                <span class="comment-count-{{ post.id }}">{{ post.comment_count }}</span>
                            </button>
                        </div>
                        
                        <button class="act-btn"><i class="fa-regular fa-bookmark"></i></button>
                    </div>

                    <!-- CAPTION -->
                    {% if post.caption %}
                    <div class="caption-area" style="margin-bottom: 10px;">
                        <span style="font-weight: 600;">
                            <a href="{% url 'accounts:profile' post.user.username %}">{{ post.user.username }}</a>
                        </span> 
                        {{ post.caption }}
                    </div>
                    {% endif %}

                    <hr class="post-separator">

                    {% comment %} <!-- COMMENTS PREVIEW -->
                    <div class="comments-preview-{{ post.id }}" style="font-size: 0.85rem; color: var(--text-main); margin-bottom: 5px;">
                        {% for comment in post.comments.all|slice:":2" %}
                            <div style="margin-bottom: 4px;">
                                <b style="margin-right: 5px;">
                                    <a href="{% url 'accounts:profile' comment.user.username %}">{{ comment.user.username }}</a>
                                </b> 
                                <span style="color: var(--text-secondary);">{{ comment.text }}</span>
                            </div>
                        {% endfor %}
                    </div> {% endcomment %}

                    <!-- COMMENT FORM -->
                    <form class="ajax-comment-form" action="{% url 'posts:add_comment' post.id %}" method="post" data-post-id="{{ post.id }}">
                        {% csrf_token %}
                        <input type="text" name="comment_text" placeholder="Add a comment..." required 
                            style="width: 100%; border: none; background: transparent; outline: none;">
                        <button type="submit" style="background:none; border:none; color:var(--accent-solid); font-weight:600; cursor:pointer;">Post</button>
                    </form>
                </div>
            </article>
        {% empty %}
            <!-- Empty State -->
            <div style="text-align: center; padding: 50px; color: var(--text-secondary);">
                <i class="fa-solid fa-layer-group" style="font-size: 3rem; margin-bottom: 15px; color: #ddd;"></i>
                <h3>Welcome to Qwik!</h3>
                <p>No posts yet. Follow some users or create a Qwip!</p>
            </div>
        {% endfor %}

    </main>

    <!-- RIGHT SIDEBAR -->
    <aside class="right-sidebar">
        {% include 'includes/right_sidebar.html' %}
    </aside>

    <div id="qwikModal" class="qwik-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h4 id="modalTitle">Comments</h4>
                <span class="modal-close">&times;</span>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Content loaded via AJAX -->
            </div>

            <div class="modal-footer" id="modalFooter" style="display: none;">
                <!-- Form injected via JS -->
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        
        // 1. CSRF Helper (Needed for POST requests like Like and Comment)
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // 2. AJAX FOLLOW LOGIC
        document.querySelectorAll('.ajax-follow-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault(); // STOPS PAGE RELOAD
                const url = this.href;
                const username = this.dataset.username;

                fetch(url, {
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'followed') {
                        // Hide all follow buttons for this specific user on the page
                        document.querySelectorAll(`.follow-area-${username}`).forEach(el => el.remove());
                    }
                });
            });
        });

        // 3. AJAX LIKE LOGIC
        document.querySelectorAll('.ajax-like-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const url = this.dataset.url;
                const postId = url.split('/').filter(Boolean).pop(); // Get ID from URL
                const icon = this.querySelector('i');
                const countSpan = document.querySelector(`.like-count-${postId}`);

                fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                .then(res => res.json())
                .then(data => {
                    countSpan.innerText = data.like_count;
                    //icon.className = data.liked ? 'fa-solid fa-heart' : 'fa-regular fa-heart';
                    //icon.style.color = data.liked ? '#e0245e' : '';

                    if (data.liked) {
                        this.classList.add('liked');
                        icon.classList.remove('fa-regular');
                        icon.classList.add('fa-solid');
                        icon.style.color = '#e0245e';
                    } else {
                        this.classList.remove('liked');
                        icon.classList.remove('fa-solid');
                        icon.classList.add('fa-regular');
                        icon.style.color = ''; // Reset to inherited color (var(--text-main))
                    }
                });
            });
        });

        // 4. AJAX COMMENT LOGIC (Post comment from feed)
        document.querySelectorAll('.ajax-comment-form').forEach(form => {
            form.addEventListener('submit', function(e) {
                e.preventDefault(); // STOPS PAGE RELOAD
                const postId = this.dataset.postId;
                const formData = new FormData(this);
                const countSpan = document.querySelector(`.comment-count-${postId}`);
                const input = this.querySelector('input[name="comment_text"]');

                fetch(this.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        input.value = ''; // Clear input field
                        // Update the count on the comment icon
                        const currentCount = parseInt(countSpan.innerText);
                        countSpan.innerText = currentCount + 1;
                        if(typeof showQwikAlert === 'function') {
                            showQwikAlert("Comment posted!");
                        }
                    }
                });
            });
        });

        // --- MODAL SYSTEM LOGIC (Likes and Comments list) ---
        const modal = document.getElementById('qwikModal');
        const modalBody = document.getElementById('modalBody');
        const modalTitle = document.getElementById('modalTitle');
        const modalFooter = document.getElementById('modalFooter');
        const closeBtn = document.querySelector('.modal-close');

        function closeModal() {
            modal.style.display = "none";
            modalFooter.innerHTML = ""; // Clean up form
            modalFooter.style.display = "none";
        }

        closeBtn.onclick = () => closeModal();
        window.onclick = (e) => { if (e.target == modal) closeModal(); };

        document.querySelectorAll('.open-likes-modal').forEach(el => {
            el.addEventListener('click', () => {
                const postId = el.dataset.postId;
                modalTitle.innerText = "Likes";
                //modalBody.innerHTML = "Loading...";
                modalBody.innerHTML = '<div style="text-align:center; padding:20px;"><i class="fa-solid fa-spinner fa-spin"></i></div>';
                modalFooter.style.display = "none";
                modal.style.display = "flex";
                fetch(`/posts/get-likes/${postId}/`).then(r => r.json()).then(data => {
                    modalBody.innerHTML = data.likes.map(u => `
                        <div class="user-row">
                            <a href="${u.profile_url}"><img src="${u.avatar}"></a>
                            <div><a href="${u.profile_url}" style="text-decoration:none; color:inherit; font-weight:600;">${u.username}</a></div>
                        </div>`).join('') || "No likes yet.";
                });
            });
        });

        document.querySelectorAll('.open-comments-modal').forEach(el => {
            el.addEventListener('click', () => {
                const postId = el.dataset.postId;
                modalTitle.innerText = "Comments";
                modalBody.innerHTML = '<div style="text-align:center; padding:20px;"><i class="fa-solid fa-spinner fa-spin"></i></div>';
                modal.style.display = "flex";

                modalFooter.style.display = "block";
                modalFooter.innerHTML = `
                    <form id="modalCommentForm" class="modal-input-group">
                        <input type="text" id="modalCommentInput" placeholder="Write a comment..." required autocomplete="off">
                        <button type="submit">Post</button>
                    </form>
                `;

                fetch(`/posts/get-comments/${postId}/`).then(r => r.json()).then(data => {
                    if(data.comments.length > 0) {
                        modalBody.innerHTML = data.comments.map(c => `
                            <div class="user-row" style="align-items:start;">
                                <a href="${c.profile_url}"><img src="${c.avatar}" style="width:30px;height:30px;"></a>
                                <div>
                                    <a href="${c.profile_url}" style="text-decoration:none; color:inherit; font-weight:600;">${c.username}</a>
                                    <span style="margin-left:5px;">${c.text}</span>
                                    <div style="font-size:0.7rem; color:var(--text-secondary); margin-top:2px;">${c.created_at || 'Just now'}</div>
                                </div>
                            </div>`).join('');
                    } else {
                        modalBody.innerHTML = '<div style="text-align:center; color:var(--text-secondary); margin-top:20px;" id="noCommentsMsg">No comments yet. Be the first!</div>';
                    }   

                     modalBody.scrollTop = modalBody.scrollHeight;
                });

                // Handle Modal Form Submit
                const modalForm = document.getElementById('modalCommentForm');
                modalForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const inputVal = document.getElementById('modalCommentInput').value;
                    
                    if(!inputVal.trim()) return;

                    const formData = new FormData();
                    formData.append('comment_text', inputVal);

                    fetch(`/posts/comment/${postId}/`, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': getCookie('csrftoken')
                        }
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.status === 'success') {
                            document.getElementById('modalCommentInput').value = '';
                            
                            // Remove "No comments" msg if exists
                            const noMsg = document.getElementById('noCommentsMsg');
                            if(noMsg) noMsg.remove();

                            // Append new comment to modal body
                            const newCommentHtml = `
                                <div class="user-row" style="align-items:start; animation: slideIn 0.3s ease;">
                                    <a href="${data.profile_url}"><img src="{% if user.profile_image %}{{ user.profile_image.url }}{% else %}https://ui-avatars.com/api/?name={{ user.username }}{% endif %}" style="width:30px;height:30px;"></a>
                                    <div>
                                        <a href="${data.profile_url}" style="text-decoration:none; color:inherit; font-weight:600;">${data.username}</a>
                                        <span style="margin-left:5px;">${data.text}</span>
                                        <div style="font-size:0.7rem; color:var(--text-secondary); margin-top:2px;">Just now</div>
                                    </div>
                                </div>`;
                            
                            modalBody.insertAdjacentHTML('beforeend', newCommentHtml);
                            modalBody.scrollTop = modalBody.scrollHeight;

                            // Update Feed Count in background
                            const countSpan = document.querySelector(`.comment-count-${postId}`);
                            if(countSpan) {
                                const currentCount = parseInt(countSpan.innerText) || 0;
                                countSpan.innerText = currentCount + 1;
                            }
                        }
                    });
                });
            });
        });
    });
    </script>
{% endblock %}