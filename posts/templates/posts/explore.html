{% extends 'base.html' %}

{% block extra_css %}
<style>
    /* Layout & Search */
    .main-content.explore-mode { width: 100%; max-width: 820px; margin-left: 30px; margin-right: auto; padding-bottom: 50px; }
    .explore-header { position: sticky; top: 0; background: var(--bg-body); padding: 20px 0; z-index: 1000; display: flex; justify-content: center; }
    .search-wrapper { position: relative; width: 100%; max-width: 480px; }
    .search-input { width: 100%; padding: 12px 45px; border-radius: 100px; border: 1px solid var(--bg-hover); background: var(--bg-card); color: var(--text-main); outline: none; }
    .search-icon { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); }
    .search-results { position: absolute; top: 110%; left: 0; width: 100%; background: var(--bg-card); border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); display: none; flex-direction: column; z-index: 1100; border: 1px solid var(--bg-hover); overflow: hidden; }
    .suggestion-item { display: flex; align-items: center; gap: 12px; padding: 10px 15px; text-decoration: none; color: inherit; transition: 0.2s; }
    .suggestion-item:hover { background: var(--bg-hover); }
    .suggestion-item img { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; }

    /* People Results (On Search Page) */
    .section-title { font-size: 1rem; font-weight: 600; margin: 20px 0 10px; color: var(--text-main); }
    .people-results { background: var(--bg-card); border-radius: 12px; overflow: hidden; margin-bottom: 25px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .user-result-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 20px; border-bottom: 1px solid var(--bg-body); }
    .user-result-info { display: flex; align-items: center; gap: 12px; }
    .user-result-info img { width: 44px; height: 44px; border-radius: 50%; }
    .view-profile-btn { padding: 6px 14px; background: var(--accent-solid); color: #fff; border-radius: 6px; font-size: 0.85rem; font-weight: 600; }

    /* Post Grid */
    .explore-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .grid-item { position: relative; aspect-ratio: 1/1; border-radius: 4px; overflow: hidden; cursor: pointer; background: #eee; }
    .grid-item img { width: 100%; height: 100%; object-fit: cover; }
    .grid-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.3); color:#fff; display:flex; justify-content:center; align-items:center; gap:15px; opacity:0; transition:0.2s; }
    .grid-item:hover .grid-overlay { opacity: 1; }

    /* Fullscreen Detail Modal */
    .detail-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 5000; align-items: center; justify-content: center; }
    .detail-container { display: flex; background: var(--bg-card); width: 90%; max-width: 1050px; height: 85vh; border-radius: 4px; overflow: hidden; position: relative; }
    .detail-img-side { flex: 1.2; background: #000; display: flex; align-items: center; justify-content: center; }
    .detail-img-side img { max-width: 100%; max-height: 100%; object-fit: contain; }
    .detail-info-side { flex: 0.8; display: flex; flex-direction: column; min-width: 350px; }
    .detail-header { padding: 15px; border-bottom: 1px solid var(--bg-hover); display: flex; align-items: center; gap: 12px; }
    .detail-header img { width: 32px; height: 32px; border-radius: 50%; }
    .detail-comments-box { flex: 1; overflow-y: auto; padding: 15px; }
    .comment-row { display: flex; gap: 12px; margin-bottom: 15px; font-size: 0.9rem; }
    .comment-row img { width: 32px; height: 32px; border-radius: 50%; }
    .detail-footer { padding: 15px; border-top: 1px solid var(--bg-hover); }
    .close-detail { position: absolute; top: 20px; right: 25px; color: #fff; font-size: 2.5rem; cursor: pointer; z-index: 5100; }
    .nav-arrow { position: absolute; top: 50%; transform: translateY(-50%); color: #fff; font-size: 2.5rem; cursor: pointer; padding: 20px; transition: 0.2s; }
    .nav-arrow.disabled { opacity: 0; pointer-events: none; }
    .arrow-left { left: 10px; } .arrow-right { right: 10px; }
</style>
{% endblock %}

{% block content %}
<main class="main-content explore-mode">
    <div class="explore-header">
        <form action="." method="GET" class="search-wrapper">
            <i class="fa-solid fa-magnifying-glass search-icon"></i>
            <input type="text" name="q" id="searchInput" class="search-input" placeholder="Search people or posts..." value="{{ query }}" autocomplete="off">
            <div id="searchResults" class="search-results"></div>
        </form>
    </div>

    {% if matched_users %}
    <div class="section-title">People</div>
    <div class="people-results">
        {% for u in matched_users %}
        <div class="user-result-item">
            <div class="user-result-info">
                <img src="{% if u.profile_image %}{{ u.profile_image.url }}{% else %}https://ui-avatars.com/api/?name={{ u.username }}{% endif %}">
                <div><b>{{ u.username }}</b><br><span>{{ u.first_name }} {{ u.last_name }}</span></div>
            </div>
            <a href="{% url 'accounts:profile' u.username %}" class="view-profile-btn">View Profile</a>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="explore-grid" id="postsGrid">
        {% for post in posts %}
        <div class="grid-item" data-post-id="{{ post.pk }}">
            <img src="{{ post.image.url }}">
            <div class="grid-overlay">
                <span><i class="fa-solid fa-heart"></i> {{ post.like_count_attr }}</span>
                <span><i class="fa-solid fa-comment"></i> {{ post.comment_count_attr }}</span>
            </div>
        </div>
        {% endfor %}
    </div>

    <div id="spinner" style="display:none; text-align:center; padding:20px;"><i class="fa-solid fa-spinner fa-spin fa-2x"></i></div>
</main>

<!-- Modal -->
<div id="detailModal" class="detail-modal">
    <span class="close-detail">&times;</span>
    <i class="fa-solid fa-chevron-left nav-arrow arrow-left" id="prevBtn"></i>
    <i class="fa-solid fa-chevron-right nav-arrow arrow-right" id="nextBtn"></i>
    <div class="detail-container">
        <div class="detail-img-side"><img id="m-img" src=""></div>
        <div class="detail-info-side">
            <div class="detail-header">
                <a id="m-user-link" href=""><img id="m-avatar" src=""></a>
                <a id="m-user-name-link" href="" style="text-decoration:none; color:inherit;"><b id="m-username"></b></a>
            </div>
            <div class="detail-comments-box" id="m-comments-list"></div>
            <div class="detail-footer">
                <div style="margin-bottom:8px;">
                    <button id="m-like-btn" style="background:none; border:none; font-size:1.5rem; cursor:pointer; margin-right:12px;"><i class="fa-regular fa-heart"></i></button>
                    <i class="fa-regular fa-comment" style="font-size:1.5rem;"></i>
                </div>
                <b id="m-like-count">0</b> likes
                <form id="m-comment-form" style="display:flex; margin-top:15px; border-top:1px solid var(--bg-hover); padding-top:10px;">
                    {% csrf_token %}
                    <input type="text" name="comment_text" placeholder="Add a comment..." required style="flex:1; border:none; outline:none; background:transparent;">
                    <button type="submit" style="background:none; border:none; color:var(--accent-solid); font-weight:600;">Post</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let loadedIds = Array.from(document.querySelectorAll('.grid-item')).map(el => el.dataset.postId);
    let currentIndex = -1;
    let currentPk = null;

    const modal = document.getElementById('detailModal');
    const commentsList = document.getElementById('m-comments-list');

    // CSRF Utility
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // 1. RAPID SEARCH
    const searchInput = document.getElementById('searchInput');
    const searchResults = document.getElementById('searchResults');
    searchInput.addEventListener('input', function() {
        const q = this.value.trim();
        if (q.length < 1) { searchResults.style.display = 'none'; return; }
        fetch(`/accounts/search-users/?q=${q}`, { headers: {'X-Requested-With': 'XMLHttpRequest'} })
            .then(r => r.json()).then(data => {
                if (data.users.length > 0) {
                    searchResults.innerHTML = data.users.map(u => `<a href="${u.profile_url}" class="suggestion-item"><img src="${u.avatar}"><span>${u.username}</span></a>`).join('');
                    searchResults.style.display = 'flex';
                } else { searchResults.style.display = 'none'; }
            });
    });

    // 2. MODAL LOADING
    function openModal(pk) {
        currentPk = pk;
        fetch(`/posts/post-detail/${pk}/`).then(r => r.json()).then(data => {
            document.getElementById('m-img').src = data.image_url;
            document.getElementById('m-avatar').src = data.user_avatar;
            document.getElementById('m-username').innerText = data.username;
            document.getElementById('m-user-link').href = data.profile_url;
            document.getElementById('m-user-name-link').href = data.profile_url;
            document.getElementById('m-like-count').innerText = data.likes_count;
            
            const icon = document.querySelector('#m-like-btn i');
            icon.className = data.is_liked ? 'fa-solid fa-heart' : 'fa-regular fa-heart';
            icon.style.color = data.is_liked ? '#e0245e' : '';

            let html = `<div class="comment-row"><img src="${data.user_avatar}"><div><b>${data.username}</b> ${data.caption}</div></div>`;
            data.comments.forEach(c => {
                html += `<div class="comment-row"><a href="${c.profile_url}"><img src="${c.avatar}"></a><div><a href="${c.profile_url}" style="text-decoration:none; color:inherit;"><b>${c.username}</b></a> ${c.text}</div></div>`;
            });
            commentsList.innerHTML = html;
            modal.style.display = 'flex';
            updateArrows();
        });
    }

    function updateArrows() {
        document.getElementById('prevBtn').classList.toggle('disabled', currentIndex <= 0);
        document.getElementById('nextBtn').classList.toggle('disabled', currentIndex >= loadedIds.length - 1);
    }

    // Grid Click listener
    document.getElementById('postsGrid').addEventListener('click', e => {
        const item = e.target.closest('.grid-item');
        if (item) {
            currentIndex = loadedIds.indexOf(item.dataset.postId);
            openModal(item.dataset.postId);
        }
    });

    // Nav Arrows
    document.getElementById('nextBtn').onclick = () => { if(currentIndex < loadedIds.length - 1) openModal(loadedIds[++currentIndex]); };
    document.getElementById('prevBtn').onclick = () => { if(currentIndex > 0) openModal(loadedIds[--currentIndex]); };

    // Close Modal
    document.querySelector('.close-detail').onclick = () => modal.style.display = 'none';
    window.onclick = e => { if (e.target == modal) modal.style.display = 'none'; };

    // 3. AJAX LIKE
    document.getElementById('m-like-btn').onclick = function() {
        fetch(`/posts/like/${currentPk}/`, { method: 'POST', headers: {'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': getCookie('csrftoken')} })
            .then(r => r.json()).then(data => {
                document.getElementById('m-like-count').innerText = data.like_count;
                const icon = this.querySelector('i');
                icon.className = data.liked ? 'fa-solid fa-heart' : 'fa-regular fa-heart';
                icon.style.color = data.liked ? '#e0245e' : '';
            });
    };

    // 4. AJAX COMMENT
    document.getElementById('m-comment-form').onsubmit = function(e) {
        e.preventDefault();
        fetch(`/posts/comment/${currentPk}/`, { method: 'POST', body: new FormData(this), headers: {'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': getCookie('csrftoken')} })
            .then(r => r.json()).then(data => {
                if(data.status === 'success') {
                    const html = `<div class="comment-row"><a href="${data.profile_url}"><img src="${data.avatar || 'https://ui-avatars.com/api/?name='+data.username}"></a><div><a href="${data.profile_url}" style="text-decoration:none; color:inherit;"><b>${data.username}</b></a> ${data.text}</div></div>`;
                    commentsList.children[0].insertAdjacentHTML('afterend', html); // Insert after caption
                    this.reset();
                }
            });
    };

    // 5. INFINITE SCROLL
    let page = 1; let hasNext = {{ posts.has_next|yesno:"true,false" }};
    window.onscroll = () => {
        if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500 && hasNext) {
            const spin = document.getElementById('spinner');
            if (spin.style.display === 'block') return;
            spin.style.display = 'block'; page++;
            fetch(`?page=${page}&q={{ query }}`, { headers: {'X-Requested-With': 'XMLHttpRequest'} })
                .then(r => r.json()).then(data => {
                    spin.style.display = 'none'; hasNext = data.has_next;
                    data.posts.forEach(p => {
                        loadedIds.push(p.id.toString());
                        document.getElementById('postsGrid').insertAdjacentHTML('beforeend', `<div class="grid-item" data-post-id="${p.id}"><img src="${p.image_url}"><div class="grid-overlay"><span><i class="fa-solid fa-heart"></i> ${p.like_count}</span><span><i class="fa-solid fa-comment"></i> ${p.comment_count}</span></div></div>`);
                    });
                });
        }
    };
});
</script>
{% endblock %}