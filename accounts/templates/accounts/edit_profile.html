{% extends 'base.html' %}

{% block title %}Edit Profile - Qwik{% endblock %}

{% block extra_css %}
<style>
    .edit-container {
        max-width: 600px; margin: 0 auto; background: var(--bg-card);
        border-radius: var(--card-radius); box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 30px;
    }
    .edit-header { margin-bottom: 25px; border-bottom: 1px solid #dadde1; padding-bottom: 15px; }
    .edit-header h2 { font-weight: 600; color: var(--text-main); }

    /* Avatar Section */
    .avatar-upload { display: flex; align-items: center; gap: 20px; margin-bottom: 30px; }
    .current-avatar {
        width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent-solid);
    }
    .upload-btn-wrapper { position: relative; overflow: hidden; display: inline-block; }
    .btn-upload {
        border: 1px solid var(--accent-solid); color: var(--accent-solid); background-color: transparent;
        padding: 8px 20px; border-radius: 8px; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: 0.2s;
    }
    .btn-upload:hover { background-color: var(--accent-solid); color: white; }
    .upload-btn-wrapper input[type=file] {
        font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer;
    }
    .btn-remove {
        border: 1px solid #e74c3c; color: #e74c3c; background: transparent;
        padding: 8px 15px; border-radius: 8px; font-size: 0.9rem; font-weight: 600; cursor: pointer; margin-left: 10px;
    }
    .btn-remove:hover { background: #e74c3c; color: white; }

    /* Form Fields */
    .form-group { margin-bottom: 20px; position: relative; }
    .form-label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-main); font-size: 0.9rem; }
    .form-input {
        width: 100%; padding: 12px 15px; border: 1px solid #dadde1; background-color: var(--bg-body);
        border-radius: 8px; font-family: 'Poppins', sans-serif; font-size: 0.95rem; color: var(--text-main); transition: 0.3s;
    }
    .form-input:focus { outline: none; border-color: var(--accent-solid); background-color: #fff; }
    
    /* Error Styles */
    .form-input.error { border-color: #e74c3c; }
    .error-msg { color: #e74c3c; font-size: 0.8rem; margin-top: 5px; display: block; }
    .success-msg { color: #2ecc71; font-size: 0.8rem; margin-top: 5px; display: block; }

    .form-actions { display: flex; justify-content: flex-end; gap: 15px; margin-top: 30px; }
    .btn-cancel {
        padding: 10px 20px; border-radius: 8px; background: var(--bg-hover); color: var(--text-secondary); font-weight: 600; border: none; cursor: pointer;
    }
    .btn-save {
        padding: 10px 30px; border-radius: 8px; background: var(--accent-gradient); color: white;
        font-weight: 600; border: none; cursor: pointer; box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
    }
    .btn-save:hover { opacity: 0.9; transform: translateY(-1px); }
    .btn-save:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }

    #id_remove_image {
        position: absolute;
        opacity: 0;
        pointer-events: none;
    }

    /* Error/Success Message Styles */
    .error-msg { color: #e74c3c; font-size: 0.8rem; margin-top: 5px; display: block; }
    .success-msg { color: #2ecc71; font-size: 0.8rem; margin-top: 5px; display: block; }
    .form-input.error { border-color: #e74c3c; }
    .form-input.valid { border-color: #2ecc71; }

</style>
{% endblock %}

{% block content %}
<div class="edit-container">
    <div class="edit-header">
        <h2>Edit Profile</h2>
    </div>

    <form method="POST" enctype="multipart/form-data" id="editForm">
        {% csrf_token %}
        {{ form.remove_image }}

        <!-- Avatar Section (Same as before) -->
        <div class="avatar-upload">
            <img id="imagePreview" 
                 src="{% if user.profile_image %}{{ user.profile_image.url }}{% else %}https://ui-avatars.com/api/?name={{ user.username }}&background=667eea&color=fff{% endif %}" 
                 class="current-avatar">
            
            <div class="upload-btn-wrapper">
                <button type="button" class="btn-upload">Change Photo</button>
                {{ form.profile_image }} 
            </div>

            <button type="button" class="btn-remove" id="removePhotoBtn" 
                {% if not user.profile_image %}style="display:none;"{% endif %}>
                Remove
            </button>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div class="form-group">
                <label class="form-label">First Name</label>
                {{ form.first_name }}
                {% if form.first_name.errors %}<span class="error-msg">{{ form.first_name.errors.0 }}</span>{% endif %}
            </div>
            <div class="form-group">
                <label class="form-label">Last Name</label>
                {{ form.last_name }}
                {% if form.last_name.errors %}<span class="error-msg">{{ form.last_name.errors.0 }}</span>{% endif %}
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Bio</label>
            {{ form.bio }}
        </div>

        <!-- Username -->
        <div class="form-group">
            <label class="form-label">Username</label>
            {{ form.username }}
            <span id="usernameMsg"></span>
            {% if form.username.errors %}<span class="error-msg">{{ form.username.errors.0 }}</span>{% endif %}
        </div>

        <!-- Email -->
        <div class="form-group">
            <label class="form-label">Email</label>
            {{ form.email }}
            <span id="emailMsg"></span>
            {% if form.email.errors %}<span class="error-msg">{{ form.email.errors.0 }}</span>{% endif %}
        </div>

        <div class="form-actions">
            <a href="{% url 'accounts:profile' user.username %}" class="btn-cancel">Cancel</a>
            <button type="submit" class="btn-save" id="saveBtn">Save Changes</button>
        </div>
    </form>
</div>

<script>
    // --- VARIABLES ---
    const fileInput = document.getElementById('fileInput');
    const imagePreview = document.getElementById('imagePreview');
    const removeBtn = document.getElementById('removePhotoBtn');
    const removeCheckbox = document.getElementById('id_remove_image'); 
    const defaultPlaceholder = "https://ui-avatars.com/api/?name={{ user.username }}&background=667eea&color=fff";

    // Store original values to prevent "Taken" error on self
    const originalUsername = "{{ user.username|escapejs }}";
    const originalEmail = "{{ user.email|escapejs }}";

    // --- 1. IMAGE LOGIC ---
    if (fileInput) {
        fileInput.addEventListener('change', function(e) {
            if (this.files && this.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreview.src = e.target.result;
                    removeBtn.style.display = 'inline-block';
                    if(removeCheckbox) removeCheckbox.checked = false;
                }
                reader.readAsDataURL(this.files[0]);
            }
        });
    }

    if (removeBtn) {
        removeBtn.addEventListener('click', function() {
            imagePreview.src = defaultPlaceholder;
            fileInput.value = ''; 
            if(removeCheckbox) removeCheckbox.checked = true;
            this.style.display = 'none';
        });
    }

    // --- 2. VALIDATION LOGIC ---
    const usernameInput = document.getElementById('id_username');
    const usernameMsg = document.getElementById('usernameMsg');
    
    const emailInput = document.getElementById('id_email');
    const emailMsg = document.getElementById('emailMsg');
    
    const saveBtn = document.getElementById('saveBtn');
    let debounceTimer;

    // Helper to set message
    function setMsg(input, el, msg, isError) {
        el.innerHTML = msg;
        if(isError) {
            el.className = "error-msg";
            input.classList.add('error');
            input.classList.remove('valid');
            saveBtn.disabled = true;
        } else {
            el.className = "success-msg";
            input.classList.remove('error');
            input.classList.add('valid');
            saveBtn.disabled = false;
        }
    }

    // USERNAME CHECK
    if (usernameInput) {
        usernameInput.addEventListener('input', function() {
            clearTimeout(debounceTimer);
            const val = this.value.trim();

            if (val.length < 3) { setMsg(this, usernameMsg, "", false); return; }
            
            // If value matches original, it's valid (it's yours)
            if (val.toLowerCase() === originalUsername.toLowerCase()) {
                setMsg(this, usernameMsg, "", false);
                return;
            }

            debounceTimer = setTimeout(() => {
                fetch(`{% url 'accounts:check_username' %}?username=${val}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.is_taken) {
                            setMsg(this, usernameMsg, "Username is taken.", true);
                        } else {
                            setMsg(this, usernameMsg, "Available", false);
                        }
                    });
            }, 500);
        });
    }

    // EMAIL CHECK
    if (emailInput) {
        emailInput.addEventListener('input', function() {
            clearTimeout(debounceTimer);
            const val = this.value.trim();
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

            if (val.length === 0) { setMsg(this, emailMsg, "", false); return; }
            
            if (!emailRegex.test(val)) {
                setMsg(this, emailMsg, "Invalid email format.", true);
                return;
            }

            // If value matches original, it's valid
            if (val.toLowerCase() === originalEmail.toLowerCase()) {
                setMsg(this, emailMsg, "", false);
                return;
            }

            debounceTimer = setTimeout(() => {
                fetch(`{% url 'accounts:check_email' %}?email=${val}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.is_taken) {
                            setMsg(this, emailMsg, "Email is already in use.", true);
                        } else {
                            setMsg(this, emailMsg, "Email available", false);
                        }
                    });
            }, 500);
        });
    }
</script>
{% endblock %}