{% extends 'base.html' %}

{% block title %}Chat with {{ other_user.username }}{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        max-width: 650px;
        margin: 20px auto;
        height: calc(100vh - 120px);
        background: var(--bg-card);
        border-radius: var(--card-radius);
        border: 1px solid var(--bg-hover);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .chat-header {
        padding: 15px 20px;
        border-bottom: 1px solid var(--bg-hover);
        display: flex;
        align-items: center;
        gap: 15px;
    }
    .chat-header img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
    .chat-header h4 { font-size: 1rem; font-weight: 600; }

    #chat-log {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        background: var(--bg-body);
    }

    .msg-wrapper { max-width: 75%; padding: 10px 15px; border-radius: 18px; font-size: 0.9rem; line-height: 1.4; }
    
    .msg-wrapper.sent {
        align-self: flex-end;
        background: var(--accent-gradient);
        color: white;
        border-bottom-right-radius: 4px;
    }
    
    .msg-wrapper.received {
        align-self: flex-start;
        background: var(--bg-card);
        color: var(--text-main);
        border: 1px solid var(--bg-hover);
        border-bottom-left-radius: 4px;
    }

    #typing-indicator {
        padding: 5px 20px;
        font-size: 0.75rem;
        color: var(--text-secondary);
        font-style: italic;
    }

    .chat-footer {
        padding: 15px;
        background: var(--bg-card);
        border-top: 1px solid var(--bg-hover);
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .chat-input {
        flex: 1;
        background: var(--bg-body);
        border: 1px solid var(--bg-hover);
        padding: 10px 18px;
        border-radius: 25px;
        outline: none;
        font-size: 0.9rem;
    }

    .send-button {
        background: none;
        border: none;
        color: var(--accent-solid);
        font-weight: 700;
        cursor: pointer;
        font-size: 0.9rem;
    }
</style>
{% endblock %}

{% block content %}
<main class="main-content" style="width: 100%;">
    <div class="chat-container">
        <!-- Header -->
        <div class="chat-header">
            <a href="{% url 'accounts:profile' other_user.username %}">
                <img src="{% if other_user.profile_image %}{{ other_user.profile_image.url }}{% else %}https://ui-avatars.com/api/?name={{ other_user.username }}{% endif %}">
            </a>
            <div>
                <h4>{{ other_user.username }}</h4>
                <small id="user-status" style="color: gray;"></small>
            </div>
        </div>

        <!-- Messages -->
        <div id="chat-log">
            {% for msg in thread_messages %}
                <div class="msg-wrapper {% if msg.sender == request.user %}sent{% else %}received{% endif %}">
                    {{ msg.text }}
                </div>
            {% endfor %}
        </div>

        <!-- Typing -->
        <div id="typing-indicator" style="display:none;">
            {{ other_user.username }} is typing...
        </div>

        <!-- Footer -->
        <div class="chat-footer">
            <input type="text" id="chat-input" class="chat-input" placeholder="Message..." autocomplete="off">
            <button id="chat-btn" class="send-button">Send</button>
        </div>
    </div>
</main>

<script>
    const chatLog = document.getElementById('chat-log');
    const input = document.getElementById('chat-input');
    const btn = document.getElementById('chat-btn');
    const typing = document.getElementById('typing-indicator');

    const socket = new WebSocket(`${window.location.protocol === 'https:' ? 'wss:' : 'ws:'}//${window.location.host}/ws/chat/{{ other_user.pk }}/`);

    chatLog.scrollTop = chatLog.scrollHeight;

    // Typing Status
    let isTyping = false;
    let typingTimer;
    input.addEventListener('input', () => {
        if(!isTyping) {
            socket.send(JSON.stringify({'action': 'typing', 'typing': true}));
            isTyping = true;
        }
        clearTimeout(typingTimer);
        typingTimer = setTimeout(() => {
            socket.send(JSON.stringify({'action': 'typing', 'typing': false}));
            isTyping = false;
        }, 2000);
    });

    socket.onmessage = function(e) {
        const data = JSON.parse(e.data);

        if (data.type === 'user_status') {
            const statusEl = document.getElementById('user-status');
            if (data.user_id != "{{ request.user.pk }}") {
                statusEl.innerText = data.status === 'online' ? 'Active now' : 'Offline';
                statusEl.style.color = data.status === 'online' ? '#4cd137' : 'gray';
            }
        }
        
        if (data.type === 'chat_message') {
            const isMe = data.sender_id == "{{ request.user.pk }}";
            const div = document.createElement('div');
            div.className = `msg-wrapper ${isMe ? 'sent' : 'received'}`;
            div.innerText = data.message;
            chatLog.appendChild(div);
            chatLog.scrollTop = chatLog.scrollHeight;
            typing.style.display = 'none';
        }

        if (data.type === 'typing_indicator' && data.user_id != "{{ request.user.pk }}") {
            typing.style.display = data.is_typing ? 'block' : 'none';
            chatLog.scrollTop = chatLog.scrollHeight;
        }
    };

    const sendMsg = () => {
        if (input.value.trim() !== "") {
            socket.send(JSON.stringify({'action': 'message', 'message': input.value}));
            input.value = '';
        }
    };

    btn.onclick = sendMsg;
    input.onkeyup = (e) => { if(e.keyCode === 13) sendMsg(); };
</script>
{% endblock %}